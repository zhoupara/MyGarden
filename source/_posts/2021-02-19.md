---
title: 'ICMP协议'
date: 2021-02-19 17:37:50
tags: '网络'
---
# ICMP协议
ICMP全称"Internet Control Message Protocol",互联网控制报文协议。
<!--more-->

# Wireshark抓包ping命令
过滤规则： ip.addr == 47.114.0.16 and icmp
抓包内容： Ethernet II + IP + ICMP

![Lena](/images/2021-02-19/wireshark.png)

## Ethernet II
```
Ethernet II： 源Mac地址(6字节) 目标mac地址(6字节) 类型(2字节)  共 14字节
```
![Lena](/images/2021-02-19/mac层.png)

## IP报文头
```
IP: 版本(4位)/首部长度(4位) (1字节) 服务类型TOS(1字节) 
	总长度(2字节)
	标识(2字节)
	标志(3位)/片偏移(13位) (2字节)
	TTL(1字节) 协议(1字节)
	首部校验和(2字节)
	源IP地址(4字节)
	目标IP地址(4字节)  共 20字节
```

## ICMP报文
![Lena](/images/2021-02-19/ip报文头.png)
```
ICMP：类型(1字节) 代码(1字节)
	 校验和(2字节)
	 根据类型和代码不同而不同
```
![Lena](/images/2021-02-19/ICMP报文.png)

# ICMP报文的格式
ICMP报文是封装在IP包里面的，属于网络层。
![Lena](/images/2021-02-19/ICMP格式.jpg)

# 查询报文类型
查询报文类型 用于诊断的查询信息.

类型				代码		状态		描述	
0 - Echo Reply	0				echo响应 (被程序ping使用）
8 - 请求回显		0				Echo请求	
9 - 路由器通告	0				路由通告
10 - 路由器请求	0				路由器的发现/选择/请求
13 - 时间戳请求	0				时间戳请求	
14 - 时间戳应答	0				时间戳应答	
常见的类型是主动请求为8，主动请求的应答为0

# 差错报文类型
差错报文类型 通知出错原因的错误消息
类型 1.2 未分配 保留

## 3-目的不可达
代码 0		目标网络不可达		
代码 1		目标主机不可达		
代码 2		目标协议不可达		
代码 3		目标端口不可达		
代码 4		要求分段并设置DF flag标志		

## 5-重定向
代码 0		重定向网络
代码 1		重定向主机
代码 2		基于TOS 的网络重定向
代码 3		基于TOS 的主机重定向

## 11-ICMP超时
代码 0		TTL 超时
代码 1 		分片重组超时

# 查询报文应用: ping命令
```
ping -c 2 www.padparadccha.cn

-c 2 收到两次包后，自动退出
-i 3 发送周期 3秒
-s 1024 设置发送包的大小
-t 255 设置TTL值为 255
```
![Lena](/images/2021-02-19/ping.png)

# 差错报文应用: Traceroute命令
```
traceroute www.padparadccha.cn 显示到达目的地的数据包路由

```
Traceroute程序的设计是利用ICMP及IP header的TTL（Time To Live）栏位（field）

>TTL是1的IP datagram（其实，每次送出的为3个40字节的包，包括源地址，目的地址和包发出的时间标签）到目的地，当路径上的第一个路由器（router）收到这个datagram时，它将TTL减1。此时，TTL变为0了，所以该路由器会将此datagram丢掉，并送回一个「ICMP time exceeded」消息（包括发IP包的源地址，IP包的所有内容及路由器的IP地址），traceroute 收到这个消息后，便知道这个路由器存在于这个路径上，接着traceroute 再送出另一个TTL是2 的datagram，发现第2 个路由器...... traceroute 每次将送出的datagram的TTL 加1来发现另一个路由器，这个重复的动作一直持续到某个datagram 抵达目的地。

>当datagram到达目的地后，该主机并不会送回ICMP time exceeded消息，因为它已是目的地了，那么traceroute如何得知目的地到达了呢？Traceroute在送出UDP datagrams到目的地时，它所选择送达的port number 是一个一般应用程序都不会用的号码（30000 以上），所以当此UDP datagram 到达目的地后该主机会送回一个「ICMP port unreachable」的消息，而当traceroute 收到这个消息时，便知道目的地已经到达了。所以traceroute 在Server端也是没有所谓的Daemon 程式。

## Traceroute规则
1.故意设置特殊的TTL，来追踪去往目的地时沿途经过的路由器
2.故意设置不分片，从而确定路径的MTU
